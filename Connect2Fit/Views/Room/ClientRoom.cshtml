@using Microsoft.AspNet.Identity
@model int
@{
    ViewBag.Title = "ClientRoom";
}

<h2>ClientRoom</h2>


<div id="demoContainer">
    <div id="connectControls">
        <div id="status">Connecting.</div>
        <br />
     
    </div>
    <div id="videos">
       
            <video autoplay="autoplay" id="callerVideo"></video>
        
    </div>
</div>

<div ng-app="Room" ng-controller="Chat" class="ng-cloak">
    <h2>Client Classes</h2>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Person</th>
                <th>Message</th>

            </tr>
        </thead>
        <tbody>
            <tr class="animation" ng-repeat="message in messages">
                <td>{{message.person}}</td>
                <td>{{message.text}}</td>

            </tr>
        </tbody>

    </table>
    <form>
        <input type="text" ng-model="newMessage" />
        <input type="submit" ng-click="addMessage()" value="Save" />
    </form>


</div>



@section scripts {
<script src='~/Scripts/angular.js'></script>
<script src="~/Scripts/jquery.signalR-2.2.0.js"></script>
<script src="~/signalr/hubs"></script>
    <link rel="stylesheet" type="text/css" href="http://ec2-52-64-224-50.ap-southeast-2.compute.amazonaws.com:8080/easyrtc/easyrtc.css" />

    <!-- Assumes global locations for socket.io.js and easyrtc.js -->
    <script src="http://ec2-52-64-224-50.ap-southeast-2.compute.amazonaws.com:8080/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="http://ec2-52-64-224-50.ap-southeast-2.compute.amazonaws.com:8080/easyrtc/easyrtc.js"></script>
    <!-- <script type="text/javascript" src="http://ec2-52-64-224-50.ap-southeast-2.compute.amazonaws.com:8080/demos/js/demo_audio_video_simple.js"></script> -->
    <script type="text/javascript">


        //signalr connection
        chat = $.connection.roomHub;
        $.connection.hub.start(
            function () {
                chat.server.joinRoom(@Model);
            }).done(function () {
                //closing stuff here
                //chat.server.leaveRoom(@Model);
            });



        var app = angular.module('Room', []);
        app.controller('Chat', function ($scope, $http) {
            var groupId = @Model;
            $scope.userId = "@User.Identity.Name";



            //hold a list of all the classes
            $scope.messages = [];

            $scope.addMessage = function () {
                //add message
                var newMessage = { person: $scope.userId, text: $scope.newMessage }
                $scope.messages.push(newMessage);
                chat.server.message(groupId, newMessage);
                $scope.newMessage = "";
            }

            //onload
            var init = function() {
                //DO STUFF HERE

            }();

            //signalr functions
            chat.client.message = function (message) {

                console.log(message);
                $scope.messages.push(message);
                $scope.$apply();

            }

            chat.client.recievePoint = function(point) {
                console.log(point);

            }


        });

        function testSendingPoint() {
            point = {clientId: 1, pointId: 2, x: 3, y: 4, z: 5 }
            chat.server.sendpoint(@Model, point);
            return "sent";

        }




    $(document).ready(function() {
        connect();

    })

    var selfEasyrtcid = "";


    function connect() {
        easyrtc.setSocketUrl("http://ec2-52-64-224-50.ap-southeast-2.compute.amazonaws.com:8080");
        //easyrtc.setVideoDims(640, 480);
        easyrtc.enableAudio(false);
        easyrtc.enableVideo(false);
        easyrtc.enableDataChannels(false);
        easyrtc.setUsername("@User.Identity.Name");
        easyrtc.joinRoom("@Model", null, null, null)
        easyrtc.setRoomOccupantListener(convertListToButtons);

        //easyrtc.easyApp("easyrtc.audioVideoSimple", null, ["callerVideo"], loginSuccess, loginFailure);
        easyrtc.connect("easyrtc.audioVideoSimple", loginSuccess, loginFailure);
    }

        easyrtc.setStreamAcceptor(function (easyrtcid, stream) {
            //setUpMirror();
            var video = document.getElementById("callerVideo");
            easyrtc.setVideoObjectSrc(video, stream);
            //enable("hangupButton");
        });


    function clearConnectList() {

    }


    function convertListToButtons(roomName, data, isPrimary) {
        console.log(roomName);
        console.log(data);
        console.log(isPrimary);
        clearConnectList();


    }


    function performCall(otherEasyrtcid) {
        easyrtc.hangupAll();

        var successCB = function () { };
        var failureCB = function () { };
        easyrtc.call(otherEasyrtcid, successCB, failureCB);
    }


    function loginSuccess(easyrtcid) {
        selfEasyrtcid = easyrtcid;
        document.getElementById("status").innerHTML = "Connected";
    }


    function loginFailure(errorCode, message) {
        easyrtc.showError(errorCode, message);
    }

    </script>

}
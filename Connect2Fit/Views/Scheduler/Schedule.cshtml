@using Microsoft.AspNet.Identity
@{
    ViewBag.Title = "Book A Class";
}


<script src='~/Scripts/angular.js'></script>
<div ng-app="schedule" ng-controller="controller"  class="ng-cloak">
    <h2>Book A Class</h2>

    <span style="margin-right:5px;cursor: pointer;" ng-repeat="day in week"  class="label" ng-class="selected(day)" ng-click="dayPicked(day)">{{day.date.calendar()}}</span>

    <table class="table table-striped">
        <thead>
            <tr>
                <th> Time</th>
                <th> Duration</th>
                <th> Class </th>
                <th> Instructor</th>
                <th> Spaces </th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="class in classes">
                <td>{{class.time}}</td>
                <td > {{class.duration}}</td>
                <td>{{class.title}}</td>
                <td>{{class.instructor}}</td>
                <td>
                    <div style="width: 80%; margin-right:3px" class="progress pull-left">
                        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="5" ng-class="progressbarColor(class)" ng-style="{ 'width': ( class.attendiesCount /5 * 100) + '%' }">
                            
                        </div>
                    </div>
                    <div class="pull-right">{{ class.attendiesCount}}/5</div>
               </td>
                <td>
                    <span  ng-if="class.LoggedInUserAttending" class="label label-success pull-right">Attending Class</span>

                <button ng-if="class.LoggedInUserAttending == false" ng-disabled="class.attendiesCount == 5" ng-click="bookClass(class)"  type="button" class="btn btn-primary pull-right">Book Class</button>
                
                </td>
            </tr>
        </tbody>

    </table>
    <div>
        {{firstName}}
    </div>

</div>



@section scripts {

    <script>
        moment.locale('en', {
            calendar: {
                lastDay: '[Yesterday]',
                sameDay: '[Today]',
                nextDay: '[Tomorrow]',
                lastWeek: '[last] dddd [at] LT',
                nextWeek: 'dddd',
                sameElse: 'L'
            }
        });
        var app = angular.module('schedule', []);
        app.controller('controller', function ($scope, $http) {
            var userId = "@User.Identity.GetUserId()";
            //hold week days in advance
            $scope.week = [];

            //selected day show a different label
            $scope.selected = function (day) {
                return day.selected == true ? "label-primary" : "label-default";
            }

            $scope.progressbarColor = function (classItem) {
                if (classItem.attendiesCount <= 2) {
                    return "progress-bar-success";
                }
                else if (classItem.attendiesCount == 3 || classItem.attendiesCount == 4) {
                    return "progress-bar-warning";
                }
                else if (classItem.attendiesCount == 5) {
                    return "progress-bar-danger";
                }


            }

            //hold a list of all the classes
            $scope.classes = [];
            $scope.classesDataLink =  "/Scheduler/scheduledClasses";

            $scope.getData = function (date) {
                $http({
                    url: $scope.classesDataLink,
                    method: "GET",
                    params: { day: date.format("YYYY-MM-DD") }
                }).success(function (response) { $scope.classes = response });
            }

            var attendClass = function(classEvent) {
                $http(
                    {
                        url: "/Scheduler/classEvent",
                        method: "POST",
                        data: {classEvent: classEvent}
                    }).success(function(respone) {
                        if (respone.message == "success") {
                            classEvent.attendiesCount++;
                            classEvent.LoggedInUserAttending = true;
                            alert("Class Booked");
                        }
                        else {
                            alert(respone.message);
                        }
                    });

            }

            $scope.dayPicked = function (day) {
                //set other days selected to false
                for (var dayX in $scope.week) {

                    $scope.week[dayX].selected = false;
                }
                //set current day to day selected
                day.selected = true;

                //Load day selected data
                $scope.getData(day.date);
            }

            //book a class
            $scope.bookClass = function (classItem) {
                
                
                //TODO back end stuff
                attendClass(classItem);
            }





            //on load populate week
            var init = function () {
                for (var x = 0; x < 7; x++) {

                    var item = { date: moment().add(x, 'days'), selected: false }
                    if (x == 0) {
                        item.selected = true;
                    }
                    $scope.week.push(item);

                }

                //load first days data
                $scope.getData(moment());

            }();



        });






</script>


    
}